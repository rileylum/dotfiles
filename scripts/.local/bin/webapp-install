#!/bin/bash

# Create a .desktop file for a web app that launches in Chromium's app mode.
# Can be run interactively or with arguments.

set -e

if [ "$#" -lt 3 ]; then
  echo -e "\e[32mLet's create a new web app you can start with the app launcher.\n\e[0m"
  APP_NAME=$(gum input --prompt "Name> " --placeholder "My favorite web app")
  APP_URL=$(gum input --prompt "URL> " --placeholder "https://example.com")
  ICON_REF=$(gum input --prompt "Icon URL> " --placeholder "See https://dashboardicons.com (must use PNG!)")
  INTERACTIVE_MODE=true
else
  APP_NAME="$1"
  APP_URL="$2"
  ICON_REF="$3"
  INTERACTIVE_MODE=false
fi

# Validate required fields
if [[ -z "$APP_NAME" || -z "$APP_URL" || -z "$ICON_REF" ]]; then
  echo "Error: You must provide app name, URL, and icon!"
  exit 1
fi

# Set up icon - download if URL, otherwise use as local path
ICON_DIR="$HOME/.local/share/applications/icons"
mkdir -p "$ICON_DIR"

if [[ $ICON_REF =~ ^https?:// ]]; then
  ICON_PATH="$ICON_DIR/$APP_NAME.png"
  if ! curl -sL -o "$ICON_PATH" "$ICON_REF"; then
    echo "Error: Failed to download icon from $ICON_REF"
    exit 1
  fi
  echo "Downloaded icon to $ICON_PATH"
else
  # Treat as filename in icons directory
  ICON_PATH="$ICON_DIR/$ICON_REF"
  if [[ ! -f "$ICON_PATH" ]]; then
    echo "Warning: Icon file not found at $ICON_PATH"
  fi
fi

# Create the .desktop file
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"

cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=$APP_NAME web application
Exec=launch-webapp $APP_URL
Terminal=false
Type=Application
Icon=$ICON_PATH
StartupNotify=true
Categories=Network;WebApp;
EOF

chmod +x "$DESKTOP_FILE"

# Update desktop database so the app appears in launchers
update-desktop-database ~/.local/share/applications 2>/dev/null || true

if [[ $INTERACTIVE_MODE == true ]]; then
  echo -e "\n\e[32mCreated $APP_NAME!\e[0m"
  echo "You can now find it using the app launcher (Super + Space)"
else
  echo "Created: $DESKTOP_FILE"
fi
